# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.9.4
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.32.2

clusterName: kubernetes
endpoint: https://#{ data.CLUSTER_API_ADDR }#:6443

clusterPodNets:
  - "#{ data.CLUSTER_POD_CIDR | default('10.42.0.0/16', true) }#"
clusterSvcNets:
  - "#{ data.CLUSTER_SVC_CIDR | default('10.43.0.0/16', true) }#"

additionalApiServerCertSans: &sans
  - "#{ data.CLUSTER_API_ADDR }#"
  #% set tls_sans_list = data.CLUSTER_API_TLS_SANS.split(',') if data.CLUSTER_API_TLS_SANS.strip() else [] %#
  #% for item in tls_sans_list %#
  - "#{ item }#"
  #% endfor %#
  - "127.0.0.1"
additionalMachineCertSans: *sans

# Disable built-in Flannel to use Cilium
cniConfig:
  name: none

nodes:
  #% for item in nodes %#
  - hostname: "#{ item.name }#"
    ipAddress: "#{ item.address }#"
    #% if item.disk.startswith('/') %#
    installDisk: "#{ item.disk }#"
    #% else %#
    installDiskSelector:
      serial: "#{ item.disk }#"
    #% endif %#
    machineSpec:
      secureboot: #{ (true if item.secureboot else false) | string | lower }#
    talosImageURL: factory.talos.dev/installer#{ "-secureboot" if item.secureboot else ""}#/#{ item.schematic_id }#
    controlPlane: #{ (item.controller) | string | lower }#
    networkInterfaces:
      - deviceSelector:
          hardwareAddr: "#{ item.mac_addr | lower }#"
        #% if data.NODE_VLAN_TAG %#
        vlans:
          - vlanId: #{ data.NODE_VLAN_TAG }#
            addresses:
              - "#{ item.address }#/#{ data.NODE_CIDR.split('/') | last }#"
            mtu: #{ item.mtu | default(1500, true) }#
            routes:
              - network: "0.0.0.0/0"
                #% if data.NODE_DEFAULT_GATEWAY %#
                gateway: "#{ data.NODE_DEFAULT_GATEWAY }#"
                #% else %#
                gateway: "#{ data.NODE_CIDR | nthhost(1) }#"
                #% endif %#
            #% if item.controller %#
            vip:
              ip: "#{ data.CLUSTER_API_ADDR }#"
            #% endif %#
        #% else %#
        dhcp: false
        addresses:
          - "#{ item.address }#/#{ data.NODE_CIDR.split('/') | last }#"
        routes:
          - network: "0.0.0.0/0"
            #% if data.NODE_DEFAULT_GATEWAY %#
            gateway: "#{ data.NODE_DEFAULT_GATEWAY }#"
            #% else %#
            gateway: "#{ data.NODE_CIDR | nthhost(1) }#"
            #% endif %#
        mtu: #{ item.mtu | default(1500, true) }#
        #% if item.controller %#
        vip:
          ip: "#{ data.CLUSTER_API_ADDR }#"
        #% endif %#
        #% endif %#
    #% if talos_patches('%s' % (item.name)) | length == 0 %#
    #% if item.encrypt_disk %#
    patches:
      - # Encrypt system disk with TPM
        |-
        machine:
          systemDiskEncryption:
            state:
              provider: luks2
              keys:
                - slot: 0
                  tpm: {}
            ephemeral:
              provider: luks2
              keys:
                - slot: 0
                  tpm: {}
    #% endif %#
    #% else %#
    #% for file in talos_patches('%s' % (item.name)) %#
    #% if loop.index == 1 %#
    patches:
    #% if item.encrypt_disk %#
      - |-
        machine:
          systemDiskEncryption:
            state:
              provider: luks2
              keys:
                - slot: 0
                  tpm: {}
            ephemeral:
              provider: luks2
              keys:
                - slot: 0
                  tpm: {}
    #% endif %#
    #% endif %#
      - "@./patches/#{ item.name }#/#{ file | basename }#"
    #% endfor %#
    #% endif %#
  #% endfor %#

#% for file in talos_patches('global') %#
#% if loop.index == 1 %#
# Global patches
patches:
#% endif %#
  - "@./patches/global/#{ file | basename }#"
#% endfor %#

#% for file in talos_patches('controller') %#
#% if loop.index == 1 %#
# Controller patches
controlPlane:
  patches:
#% endif %#
    - "@./patches/controller/#{ file | basename }#"
#% endfor %#

#% if (nodes | selectattr('controller', 'equalto', False) | list | length) and (talos_patches('worker') | length) %#
#% for file in talos_patches('worker') %#
#% if loop.index == 1 %#
# Worker patches
worker:
  patches:
#% endif %#
    - "@./patches/worker/#{ file | basename }#"
#% endfor %#
#% endif %#
